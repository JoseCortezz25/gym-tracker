# Session Context: Routine System Reform

**Session ID**: `20251106_220103`
**Created**: 2025-11-06
**Status**: In Progress

---

## Original Request

User wants to completely reform the routine system with the following requirements:

### New Structure
1. **Routine** - Has a name
2. **Training Divisions** (Divisiones de entrenamientos)
   - Each division has:
     - Name
     - Frequency (how often it should be done)
     - Brief description
3. **Exercises per Division**
   - Each exercise includes:
     - YouTube video URL
     - Exercise title
     - Sets and reps section
     - Load/weight (kg)
     - Rest time between sets
     - Load progression history (save history each time weight is saved to compare with past)
     - Notes/annotations (ability to write comments)

### Problems with Current System
- Current UI is not optimal and needs better planning
- Structure doesn't match the user's mental model of training divisions
- Missing key features like video integration, load history, and notes

---

## Current Implementation Analysis

### Database Schema (Prisma)
- **Routine**: id, name, isActive, isArchived, userId
- **RoutineDay**: id, name, dayOfWeek (enum), order, routineId
- **RoutineExercise**: id, order, targetSets, targetReps, targetWeight, restSeconds, notes, routineDayId, exerciseId

### Key Observations
1. Current `RoutineDay` model uses `dayOfWeek` enum (MONDAY-SUNDAY) which is inflexible
2. Missing:
   - Frequency concept for training divisions
   - Description field for divisions
   - YouTube video URL for exercises
   - Load progression history tracking
3. The current model is day-focused, but user wants a "training division" concept (which can occur multiple times per week)

### UI Components
- `RoutineEditorForm`: Complex form with multi-step flow
- `ExerciseSelector`: Modal for selecting exercises
- `RoutineCard`: Display card for routines list
- Issues: Form is complex, doesn't allow detailed exercise configuration

---

## Technical Requirements

### Database Schema Changes Needed
1. Rename `RoutineDay` → `TrainingDivision` or keep name but change semantics
2. Replace `dayOfWeek` enum with `frequency` (number of times per week)
3. Add `description` field to divisions
4. Add `videoUrl` field to `RoutineExercise` or `Exercise`
5. Create `ExerciseLoadHistory` model to track weight progression over time

### UI/UX Requirements
1. Better routine creation flow with clear steps
2. Detailed exercise configuration interface (video, sets, reps, rest, notes)
3. Load history visualization
4. Mobile-responsive design
5. Better visual hierarchy and spacing

### Business Logic Requirements
1. Training division frequency management
2. Load history tracking and comparison
3. Video URL validation (YouTube)
4. Better exercise reordering within divisions
5. Progressive overload tracking

---

## Agents to Invoke

1. **Business Analyst** - Refine requirements and edge cases
2. **UX/UI Designer** - Design improved user interface and flows
3. **Domain Architect** - Design business logic and data models
4. **Next.js Builder** - Plan Next.js architecture and routing
5. **Code Reviewer** - Review implementation against constraints

---

## Next Steps

1. Create session context (DONE)
2. Invoke business analyst to clarify requirements (DONE)
3. Invoke UX/UI designer for interface design
4. Invoke domain architect for data model and business logic
5. Invoke Next.js builder for implementation architecture
6. Execute implementation plan
7. Test and validate

---

## Session Entry: Business Requirements Analysis

**Agent**: business-analyst
**Date**: 2025-11-06
**Status**: Complete

### Work Completed

Created comprehensive requirements document: `.claude/plans/routine-reform-requirements.md`

**Document includes**:
- Executive summary and problem statement
- Stakeholder analysis (gym enthusiasts, personal trainers, decision makers)
- Clear scope definition (in/out of scope, assumptions, dependencies)
- 23 detailed user stories across 5 epics:
  - Epic 1: Training Division Management (4 stories)
  - Epic 2: Exercise Configuration (6 stories)
  - Epic 3: Load Progression History (3 stories)
  - Epic 4: Routine Creation UX (4 stories)
  - Epic 5: Mobile-First Experience (2 stories)
- 30+ functional requirements with acceptance criteria
- 25+ non-functional requirements (performance, security, usability, accessibility, reliability, maintainability, scalability)
- 10 business rules with validation logic
- 8 detailed data entity definitions with relationships and constraints
- 2 integration requirements (YouTube iframe API, YouTube Data API)
- 6 UI wireframe specifications
- 7 risk assessments with mitigation strategies
- 8 success metrics/KPIs
- 4 implementation phases with timelines
- 7 open questions for stakeholder decision
- Comprehensive glossary and references

### Key Requirements Clarified

**Frequency Concept**:
- Training divisions use frequency (1-7 times per week) instead of fixed days
- Users manually decide when to train each division (flexibility)
- System provides informational guidance, not enforcement (MVP approach)

**Data Model Changes**:
- Rename/restructure `RoutineDay` → `TrainingDivision`
- Remove `dayOfWeek` enum, add `frequency` integer (1-7)
- Add `description` field to divisions (max 200 chars)
- Add `videoId` field to `RoutineExercise` (11-char YouTube ID)
- No new table needed for load history (use existing `WorkoutSet` data)

**Video Integration**:
- YouTube only for MVP (dominant platform for fitness content)
- Store video ID (11 chars), not full URL (stability, flexibility)
- Use YouTube iframe API for embedding (no rate limits)
- Optional: YouTube Data API for metadata (rate limits apply, degrade gracefully)

**Load Progression History**:
- Query existing `WorkoutSet` model filtered by exercise + user
- Display last 5 workouts by default, expandable to full history
- Calculate metrics: total volume, max weight, max reps, PRs
- Visual indicators for progressive overload (green up arrow, etc.)

**Migration Strategy**:
- Auto-migrate existing routines using heuristic mapping
- Preserve all historical workout data (critical requirement)
- Use database transactions for atomic migration
- Provide manual fix UI for edge cases

### Business Rules Defined

1. Frequency must be 1-7 (realistic weekly training)
2. Division names unique per routine (case-insensitive)
3. Weight stored in kg (offer display conversion to lbs)
4. YouTube video ID storage (not full URL)
5. Historical data preservation (don't delete on template changes)
6. Single active routine per user (optional, validate with users)
7. No duplicate exercises per division (unique constraint)
8. Load history tracked per exercise per user (cross-routine)
9. Rep range format flexible (string: "10", "8-12", "AMRAP")
10. Rest time optional (0 or null = no timer shown)

### Edge Cases Identified

- Division frequency set to 0 or >7 → Validation error
- Duplicate division names → Validation error with suggestion
- YouTube video deleted/private → Show error in player, don't break UI
- Large workout history (100+ workouts) → Pagination, caching, indexes
- Concurrent edits → Optimistic concurrency control
- YouTube API rate limits → Cache metadata, degrade gracefully
- Migration failures → Rollback, feature flag, manual fix UI

### Open Questions for Stakeholders

1. Should frequency be enforced or just informational? (Recommend: informational for MVP)
2. Support imperial units (lbs) or metric only? (Recommend: metric only for MVP)
3. Allow >7 frequency for multiple daily sessions? (Recommend: cap at 7 for MVP)
4. Support non-YouTube video platforms? (Recommend: YouTube only for MVP)
5. Allow inline exercise creation in routine editor? (Recommend: yes, via modal)
6. Implement routine versioning for audit trail? (Recommend: no versioning for MVP)
7. Auto-migrate all routines or manual conversion? (Recommend: auto-migrate with review)

### Success Metrics Defined

- 70% of users create routine with new system within 30 days
- 3-5 training divisions per routine average
- 40% of exercises have video URL within 60 days
- 50% of users view load history weekly
- < 2 seconds page load time (P95)
- 4.0+ star user rating for routine creation experience
- 70% 30-day retention for users who create routine
- < 1% mutation failure rate

### Implementation Phases

**Phase 1 (MVP)**: 3-4 weeks
- Database migration, training division CRUD, exercise configuration with video/load history, redesigned UI, tests

**Phase 2 (Enhancements)**: 2-3 weeks
- PR tracking, progressive overload indicators, drag-and-drop, routine cloning, charts

**Phase 3 (Optimization)**: 1-2 weeks
- Performance tuning, offline support, accessibility, test coverage increase, routine templates

**Phase 4 (Advanced)**: Future
- AI recommendations, social features, trainer-client, advanced analytics, wearables integration

### Risks and Mitigation

**High-risk items**:
1. Data migration complexity → Comprehensive testing, rollback capability, transaction-based
2. Complex UI development time → Incremental delivery, use existing components, buffer time
3. Scope creep → Clear MVP definition, prioritization framework, regular reviews

**Medium-risk items**:
4. YouTube API rate limits → Caching, degrade gracefully, use iframe-only as fallback
5. Performance with large history → Indexes, pagination, caching, denormalization if needed
6. User confusion with frequency concept → Onboarding tooltips, examples, user testing
7. Video embeds slow page load → Lazy loading, click-to-load, limit visible embeds

### Next Steps

**Immediate** (before technical planning):
1. Review requirements document with stakeholders
2. Answer open questions (frequency enforcement, units, etc.)
3. Validate assumptions with user interviews/surveys

**Technical Planning** (ready to start):
1. Invoke **domain-architect** to design data model, business logic, repositories
2. Invoke **ux-ui-designer** to design UI/UX flows, wireframes, component structure
3. Invoke **nextjs-builder** to plan Next.js architecture, Server Actions, form handling

**Recommendation**: Start with domain-architect to finalize data model and migration strategy, as this is the foundation for all subsequent work.

---

## Session Entry: Domain Architecture Design

**Agent**: Parent Agent (Manual)
**Date**: 2025-11-07
**Status**: Complete

### Work Completed

Created domain architecture plan: `.claude/plans/routine-reform-domain-architecture.md`

**Document includes**:
- Complete updated Prisma schema with all changes
- 4-phase migration strategy (add columns → migrate data → rename tables → remove old columns)
- Rollback SQL script for emergency recovery
- Complete repository layer redesign with all CRUD methods
- New load history query implementation (no new table needed)
- Updated Zod validation schemas with YouTube video ID validation
- YouTube video ID extraction helper function
- Implementation checklist and risk assessment

**Key Design Decisions**:
- Rename `RoutineDay` → `TrainingDivision` at database level
- Rename `RoutineExercise` → `DivisionExercise` for clarity
- Store YouTube video ID (11 chars) not full URL
- Notes field changed from VARCHAR to TEXT for longer content
- Added indexes on exerciseId for load history queries
- Load history calculated from existing `WorkoutSet` data

---

## Session Entry: UX/UI Architecture Design

**Agent**: ux-ui-designer (automated)
**Date**: 2025-11-06
**Status**: Complete

### Work Completed

Created UX/UI architecture plan: `.claude/plans/routine-reform-ux-architecture.md`

**Document includes**:
- Complete user flow redesign (routine creation, viewing, load history)
- Detailed component tree with Atomic Design structure
- Wireframe specifications for all screens (editor, modals, mobile)
- Component specifications with props and state
- shadcn/ui component usage mapping
- Responsive design strategy (mobile-first, 3 breakpoints)
- State management strategy (React Query + useState, NO Zustand)

**Key UX Decisions**:
- 3-column layout for desktop (divisions | detail | history)
- Single-page editor (no multi-step wizard)
- Modal-based forms for division/exercise config
- Live YouTube video preview in forms
- Chart/table toggle for load history
- Drag-and-drop for reordering (future enhancement)
- Mobile: bottom sheets, collapsible sidebar

**Component Architecture**:
- 4 new atoms: YouTubeEmbed, PRBadge, FrequencyBadge, DragHandle
- 8 new molecules: DivisionCard, DivisionForm, FrequencySelector, VideoInput, ExerciseConfigForm, LoadHistoryChart, LoadHistoryTable, ExerciseCard (updated)
- 4 new organisms: RoutineEditor, DivisionManager, DivisionDetailView, LoadHistoryPanel

---

## Session Entry: Next.js Implementation Plan

**Agent**: Parent Agent (Manual)
**Date**: 2025-11-07
**Status**: Complete

### Work Completed

Created implementation roadmap: `.claude/plans/routine-reform-nextjs-implementation.md`

**Document includes**:
- Step-by-step implementation order (11 steps)
- Detailed code examples for each step
- Server Actions specifications
- React Query hooks specifications
- Page routing structure
- Text map updates
- Testing strategy (unit, component, integration, manual)
- Deployment strategy (3 phases: backend → UI → deprecate old)
- Rollback plan
- Success criteria checklist
- 4-5 week implementation timeline

**Implementation Steps**:
1. Database migration
2. Update repository layer
3. Update validation schemas
4. Update types
5. Create/update Server Actions
6. Create React Query hooks
7. Build atom components
8. Build molecule components
9. Build organism components
10. Update/create pages
11. Update text maps

**Ready to Execute**: All planning complete, can begin implementation.

---

## Planning Summary

### Documents Created
1. ✅ **Requirements** - `.claude/plans/routine-reform-requirements.md` (72KB)
2. ✅ **Domain Architecture** - `.claude/plans/routine-reform-domain-architecture.md` (24KB)
3. ✅ **UX/UI Architecture** - `.claude/plans/routine-reform-ux-architecture.md` (106KB)
4. ✅ **Implementation Plan** - `.claude/plans/routine-reform-nextjs-implementation.md` (18KB)

**Total Planning Output**: ~220KB of comprehensive documentation

### Next Action Required

**User Decision**: Proceed with implementation?

**Options**:
1. **Start implementation now** - Begin with STEP 1 (Database Migration)
2. **Review plans first** - User reviews all documents before proceeding
3. **Modify plans** - User requests changes to any aspect of the design

**Recommendation**: Review the 3 key documents first:
- Domain architecture (database changes)
- UX architecture (component structure)
- Implementation plan (execution steps)

Then provide feedback or approval to proceed.

---
